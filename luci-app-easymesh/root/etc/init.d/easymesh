#!/bin/sh /etc/rc.common
# /etc/init.d/easymesh
USE_PROCD=1
START=95
STOP=10

UCI_APP=easymesh

. /lib/functions.sh
. /lib/functions/network.sh

log() { logger -t easymesh "$*"; }

# ── Find radio for given band ─────────────────────────────────────────────────
_band_target=""; _found=""
_find_radio() {
    local _n="$1"; local _b
    config_get _b "$_n" band
    case "$_b" in
        2g|2.4GHz|bgn|bg|b) [ "$_band_target" = "2g" ] && _found="$_n" ;;
        5g|5GHz|an|a)        [ "$_band_target" = "5g" ] && _found="$_n" ;;
    esac
}
get_radio() {
    local _v="$1" _b="$2"; _found=""; _band_target="$_b"
    config_load wireless; config_foreach _find_radio wifi-device
    eval "$_v='$_found'"
}

# ── Clean up plugin-managed wireless interfaces ───────────────────────────────
_del_managed() {
    local _n="$1"; local _m
    config_get _m "$_n" easymesh_managed
    [ "$_m" = "1" ] && uci -q del wireless."$_n" && log "Removed old interface: $_n"
}
cleanup_wireless() { config_load wireless; config_foreach _del_managed wifi-iface; }
cleanup_network() {
    uci -q del network.mesh; uci -q del network.bat0
    local ifn; ifn=$(uci get network.lan.ifname 2>/dev/null)
    echo "$ifn" | grep -qw bat0 && {
        ifn=$(echo "$ifn" | tr ' ' '\n' | grep -v '^bat0$' | tr '\n' ' ' | sed 's/ $//')
        uci set network.lan.ifname="$ifn"
    }
}

# ── Apply full Mesh configuration ─────────────────────────────────────────────
apply_mesh_config() {
    local role backhaul mesh_id mesh_key mesh_band ssid key
    local ieee80211r mobility_domain ft_over_ds reassociation_deadline
    local ieee80211k ieee80211v routing_algo mesh_fwding

    config_load "$UCI_APP"
    config_get role                   global role                  'slave'
    config_get backhaul               global backhaul              'wired'
    config_get mesh_id                global mesh_id               'OpenWrt-Mesh'
    config_get mesh_key               global mesh_key              ''
    config_get mesh_band              global mesh_band             '5g'
    config_get ssid                   global ssid                  'OpenWrt'
    config_get key                    global key                   ''
    config_get ieee80211r             global ieee80211r            '1'
    config_get mobility_domain        global mobility_domain       'aabb'
    config_get ft_over_ds             global ft_over_ds            '1'
    config_get reassociation_deadline global reassociation_deadline '1000'
    config_get ieee80211k             global ieee80211k            '1'
    config_get ieee80211v             global ieee80211v            '1'
    config_get routing_algo           global routing_algo          'BATMAN_IV'
    config_get mesh_fwding            global mesh_fwding           '0'

    cleanup_wireless
    cleanup_network

    local radio_mesh
    get_radio radio_mesh "$mesh_band"
    [ -z "$radio_mesh" ] && radio_mesh="radio0"

    # batman-adv — tuned for fast convergence and self-healing
    uci set batman-adv.bat0=mesh
    uci set batman-adv.bat0.interfaces='mesh0'
    uci set batman-adv.bat0.routing_algo="$routing_algo"
    uci set batman-adv.bat0.aggregated_ogms='true'
    uci set batman-adv.bat0.orig_interval='500'    # 500ms: faster failure detection
    uci set batman-adv.bat0.hop_penalty='30'
    if [ "$role" = "master" ]; then
        uci set batman-adv.bat0.gw_mode='server'  # advertise as internet gateway
    else
        uci set batman-adv.bat0.gw_mode='client'  # select best-TQ path to gateway
    fi
    uci commit batman-adv

    # network
    uci set network.mesh=interface
    uci set network.mesh.proto='batadv_hardif'
    uci set network.mesh.master='bat0'
    uci set network.mesh.mtu='1536'
    uci set network.bat0=interface
    uci set network.bat0.proto='batadv'
    uci set network.bat0.routing_algo="$routing_algo"

    if [ "$role" = "master" ]; then
        log "Role: master"
        local cur; cur=$(uci get network.lan.ifname 2>/dev/null || echo "eth0")
        echo "$cur" | grep -qw bat0 || uci set network.lan.ifname="$cur bat0"
        uci set network.lan.type='bridge'
    else
        log "Role: slave"
        uci set network.bat0.proto='dhcp'
        uci set dhcp.lan.ignore='1'
    fi
    uci commit network

    # Wireless: mesh backhaul (disabled if wired)
    uci set wireless.mesh0=wifi-iface
    uci set wireless.mesh0.device="$radio_mesh"
    uci set wireless.mesh0.mode='mesh'
    uci set wireless.mesh0.mesh_id="$mesh_id"
    uci set wireless.mesh0.mesh_fwding="$mesh_fwding"
    uci set wireless.mesh0.mesh_rssi_threshold='-80'
    uci set wireless.mesh0.network='mesh'
    uci set wireless.mesh0.easymesh_managed='1'
    if [ -n "$mesh_key" ]; then
        uci set wireless.mesh0.encryption='sae'
        uci set wireless.mesh0.key="$mesh_key"
    else
        uci set wireless.mesh0.encryption='none'
    fi
    [ "$backhaul" = "wired" ] && uci set wireless.mesh0.disabled='1'

    # Wireless: client AP
    uci set wireless.easymesh_ap=wifi-iface
    uci set wireless.easymesh_ap.device="$radio_mesh"
    uci set wireless.easymesh_ap.mode='ap'
    uci set wireless.easymesh_ap.ssid="$ssid"
    uci set wireless.easymesh_ap.network='lan'
    uci set wireless.easymesh_ap.easymesh_managed='1'
    if [ -n "$key" ]; then
        uci set wireless.easymesh_ap.encryption='psk2+ccmp'
        uci set wireless.easymesh_ap.key="$key"
    else
        uci set wireless.easymesh_ap.encryption='none'
    fi
    [ "$ieee80211r" = "1" ] && {
        uci set wireless.easymesh_ap.ieee80211r='1'
        uci set wireless.easymesh_ap.mobility_domain="$mobility_domain"
        uci set wireless.easymesh_ap.ft_over_ds="$ft_over_ds"
        uci set wireless.easymesh_ap.ft_psk_generate_local='1'
        uci set wireless.easymesh_ap.reassociation_deadline="$reassociation_deadline"
    }
    [ "$ieee80211k" = "1" ] && {
        uci set wireless.easymesh_ap.ieee80211k='1'
        uci set wireless.easymesh_ap.rrm_neighbor_report='1'
        uci set wireless.easymesh_ap.rrm_beacon_report='1'  # allows RSSI probe responses
    }
    [ "$ieee80211v" = "1" ] && {
        uci set wireless.easymesh_ap.ieee80211v='1'
        uci set wireless.easymesh_ap.bss_transition='1'
    }
    uci commit wireless
    wifi reload
    log "Config applied"
}

# ── procd service ─────────────────────────────────────────────────────────────
start_service() {
    local enabled role
    config_load "$UCI_APP"
    config_get enabled global enabled '0'
    config_get role    global role    'slave'

    [ "$enabled" != "1" ] && { log "EasyMesh disabled, skipping"; return; }

    apply_mesh_config
    /etc/init.d/network restart &

    # Both master and slave run the same daemon.
    # The daemon elects its own role at runtime via WAN detection.
    # master: serves /profile, manages approvals, runs channel/LB tasks
    # slave:  discovers master on LAN, registers, polls for approval & config
    if [ "$role" = "master" ]; then
        procd_open_instance "easymesh-master"
        procd_set_param command /usr/sbin/easymesh-master
        procd_set_param respawn 60 5 0
        procd_set_param stdout 1
        procd_set_param stderr 1
        procd_close_instance
    else
        procd_open_instance "easymesh-agent"
        procd_set_param command /usr/sbin/easymesh-agent
        procd_set_param respawn 60 5 0
        procd_set_param stdout 1
        procd_set_param stderr 1
        procd_close_instance
    fi
}

stop_service() {
    cleanup_wireless
    cleanup_network
    uci commit wireless
    uci commit network
    /etc/init.d/network restart &
}

reload_service() { stop_service; start_service; }

service_triggers() { procd_add_reload_trigger "$UCI_APP"; }
