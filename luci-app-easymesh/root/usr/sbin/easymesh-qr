#!/bin/sh
# /usr/sbin/easymesh-qr
# 主节点配对码管理：生成、验证、撤销一次性 token
# 被 easymesh-master HTTP 服务和 LuCI JS 调用

QR_DIR="/tmp/easymesh_qr_tokens"
TOKEN_TTL=600   # 10分钟有效期

mkdir -p "$QR_DIR"

# ── 生成新 token ──────────────────────────────
generate() {
    # 清理过期 token
    local now
    now=$(date +%s)
    for f in "${QR_DIR}"/*; do
        [ -f "$f" ] || continue
        local exp
        exp=$(cat "$f" 2>/dev/null)
        [ -n "$exp" ] && [ "$now" -gt "$exp" ] && rm -f "$f"
    done

    # 生成32位随机 token
    local token
    token=$(head -c 16 /dev/urandom | hexdump -v -e '1/1 "%02x"')
    local expire=$((now + TOKEN_TTL))

    echo "$expire" > "${QR_DIR}/${token}"

    # 获取主节点 LAN IP
    local ip
    ip=$(uci get network.lan.ipaddr 2>/dev/null || echo "192.168.1.1")

    # 输出二维码内容（JSON）
    printf '{"ip":"%s","token":"%s","expire":%d}' "$ip" "$token" "$expire"
}

# ── 验证 token 并返回配置 ─────────────────────
verify() {
    local token="$1"
    local token_file="${QR_DIR}/${token}"

    # 检查文件存在
    [ -f "$token_file" ] || {
        echo '{"status":"invalid"}'
        return
    }

    # 检查有效期
    local exp now
    exp=$(cat "$token_file")
    now=$(date +%s)
    [ "$now" -gt "$exp" ] && {
        rm -f "$token_file"
        echo '{"status":"expired"}'
        return
    }

    # token 有效：删除（一次性使用）并返回 Mesh 配置
    rm -f "$token_file"

    # 读取 Mesh 配置
    . /lib/functions.sh
    config_load easymesh
    local mesh_id mesh_key ssid key mobility_domain
    local ieee80211r ieee80211k ieee80211v mesh_band routing_algo
    config_get mesh_id        global mesh_id         'OpenWrt-Mesh'
    config_get mesh_key       global mesh_key         ''
    config_get ssid           global ssid             'OpenWrt'
    config_get key            global key              ''
    config_get mobility_domain global mobility_domain 'aabb'
    config_get ieee80211r     global ieee80211r        '1'
    config_get ieee80211k     global ieee80211k        '1'
    config_get ieee80211v     global ieee80211v        '1'
    config_get mesh_band      global mesh_band         '5g'
    config_get routing_algo   global routing_algo      'BATMAN_IV'

    printf '{"status":"approved","mesh_id":"%s","mesh_key":"%s","ssid":"%s","wifi_key":"%s","mobility_domain":"%s","ieee80211r":"%s","ieee80211k":"%s","ieee80211v":"%s","mesh_band":"%s","routing_algo":"%s"}' \
        "$mesh_id" "$mesh_key" "$ssid" "$key" "$mobility_domain" \
        "$ieee80211r" "$ieee80211k" "$ieee80211v" "$mesh_band" "$routing_algo"
}

case "$1" in
    generate) generate ;;
    verify)   verify "$2" ;;
    *)
        echo "Usage: $0 {generate|verify <token>}" >&2
        exit 1
        ;;
esac
