<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>EasyMesh èŠ‚ç‚¹é…å¯¹</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, "PingFang SC", "Helvetica Neue", sans-serif;
    background: #0d1117;
    color: #e6edf3;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  .card {
    width: 100%;
    max-width: 360px;
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 16px;
    padding: 32px 24px;
    text-align: center;
  }

  .logo { font-size: 48px; margin-bottom: 16px; }

  h1 {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .subtitle {
    font-size: 13px;
    color: #7d8590;
    line-height: 1.6;
    margin-bottom: 28px;
  }

  /* çŠ¶æ€è§†å›¾åˆ‡æ¢ */
  .view { display: none; }
  .view.active { display: block; }

  /* æ‰«ç æŒ‰é’® */
  .scan-btn {
    width: 100%;
    padding: 14px;
    background: #2ea44f;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: background 0.2s, transform 0.1s;
  }
  .scan-btn:active { background: #2dbe4e; transform: scale(0.98); }

  /* æ‘„åƒå¤´è§†å›¾ */
  #camera-container {
    position: relative;
    width: 100%;
    aspect-ratio: 1;
    border-radius: 12px;
    overflow: hidden;
    background: #000;
    margin-bottom: 16px;
  }
  #video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .scan-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .scan-frame {
    width: 60%;
    aspect-ratio: 1;
    border: 2px solid #2ea44f;
    border-radius: 8px;
    box-shadow: 0 0 0 1000px rgba(0,0,0,0.4);
    animation: scan-pulse 2s ease-in-out infinite;
  }
  @keyframes scan-pulse {
    0%,100% { border-color: #2ea44f; box-shadow: 0 0 0 1000px rgba(0,0,0,0.4), 0 0 12px rgba(46,164,79,0.4); }
    50% { border-color: #3dd56d; box-shadow: 0 0 0 1000px rgba(0,0,0,0.4), 0 0 20px rgba(46,164,79,0.7); }
  }
  .cancel-btn {
    width: 100%;
    padding: 12px;
    background: transparent;
    color: #7d8590;
    border: 1px solid #30363d;
    border-radius: 10px;
    font-size: 14px;
    cursor: pointer;
  }

  /* è¿›åº¦çŠ¶æ€ */
  .progress-list {
    text-align: left;
    margin: 20px 0;
  }
  .progress-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    font-size: 14px;
    color: #7d8590;
    border-bottom: 1px solid #21262d;
    transition: color 0.3s;
  }
  .progress-item:last-child { border-bottom: none; }
  .progress-item.done { color: #e6edf3; }
  .progress-item.active { color: #2ea44f; }
  .progress-item.error { color: #f85149; }
  .step-icon { font-size: 16px; width: 24px; text-align: center; flex-shrink: 0; }

  /* æ—‹è½¬åŠ è½½ */
  .spin {
    display: inline-block;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* æˆåŠŸ/å¤±è´¥ */
  .result-icon { font-size: 56px; margin-bottom: 16px; }
  .result-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
  .result-desc { font-size: 13px; color: #7d8590; line-height: 1.6; }

  .retry-btn {
    margin-top: 20px;
    width: 100%;
    padding: 12px;
    background: transparent;
    color: #2ea44f;
    border: 1px solid #2ea44f;
    border-radius: 10px;
    font-size: 14px;
    cursor: pointer;
  }

  canvas#qr-canvas { display: none; }
</style>
</head>
<body>

<div class="card">
  <div class="logo">ğŸ•¸</div>
  <h1>EasyMesh èŠ‚ç‚¹é…å¯¹</h1>
  <p class="subtitle">æ‰«æä¸»èŠ‚ç‚¹ä¸Šæ˜¾ç¤ºçš„äºŒç»´ç ï¼Œè‡ªåŠ¨å®Œæˆ Mesh ç»„ç½‘é…ç½®</p>

  <!-- è§†å›¾1ï¼šå‡†å¤‡æ‰«ç  -->
  <div class="view active" id="view-ready">
    <button class="scan-btn" onclick="startScan()">
      <span>ğŸ“·</span> æ‰«æä¸»èŠ‚ç‚¹äºŒç»´ç 
    </button>
    <p style="margin-top:14px;font-size:12px;color:#7d8590">
      è¯·å…ˆåœ¨ä¸»èŠ‚ç‚¹ LuCI â†’ EasyMesh â†’ æ˜¾ç¤ºé…å¯¹ç 
    </p>
  </div>

  <!-- è§†å›¾2ï¼šæ‘„åƒå¤´æ‰«ç  -->
  <div class="view" id="view-camera">
    <div id="camera-container">
      <video id="video" autoplay playsinline muted></video>
      <div class="scan-overlay">
        <div class="scan-frame"></div>
      </div>
    </div>
    <canvas id="qr-canvas"></canvas>
    <button class="cancel-btn" onclick="stopScan()">å–æ¶ˆ</button>
  </div>

  <!-- è§†å›¾3ï¼šé…å¯¹è¿›è¡Œä¸­ -->
  <div class="view" id="view-pairing">
    <div class="progress-list" id="progress-list">
      <div class="progress-item" id="step-qr">
        <span class="step-icon">âœ“</span>
        <span>è¯»å–äºŒç»´ç </span>
      </div>
      <div class="progress-item" id="step-connect">
        <span class="step-icon spin">âŸ³</span>
        <span>è¿æ¥ä¸»èŠ‚ç‚¹...</span>
      </div>
      <div class="progress-item" id="step-config">
        <span class="step-icon">â—‹</span>
        <span>è·å– Mesh é…ç½®</span>
      </div>
      <div class="progress-item" id="step-apply">
        <span class="step-icon">â—‹</span>
        <span>åº”ç”¨é…ç½®å¹¶é‡å¯</span>
      </div>
    </div>
  </div>

  <!-- è§†å›¾4ï¼šæˆåŠŸ -->
  <div class="view" id="view-success">
    <div class="result-icon">ğŸ‰</div>
    <div class="result-title">é…å¯¹æˆåŠŸï¼</div>
    <div class="result-desc">
      æœ¬èŠ‚ç‚¹å·²æˆåŠŸåŠ å…¥ Mesh ç½‘ç»œã€‚<br>
      è·¯ç”±å™¨å³å°†é‡å¯ï¼ˆçº¦30ç§’ï¼‰ï¼Œ<br>
      é‡å¯åå°†è‡ªåŠ¨è¿æ¥ Mesh ç½‘ç»œã€‚
    </div>
    <div style="margin-top:20px;padding:12px;background:#0d1117;border-radius:8px;font-size:12px;color:#7d8590">
      é‡å¯å®Œæˆåï¼Œå¯å°†æœ¬èŠ‚ç‚¹ç§»åˆ°éœ€è¦æ‰©å±•è¦†ç›–çš„ä½ç½®
    </div>
  </div>

  <!-- è§†å›¾5ï¼šå¤±è´¥ -->
  <div class="view" id="view-error">
    <div class="result-icon">âŒ</div>
    <div class="result-title">é…å¯¹å¤±è´¥</div>
    <div class="result-desc" id="error-msg">è¯·æ£€æŸ¥ä¸»èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸è¿è¡Œ</div>
    <button class="retry-btn" onclick="showView('view-ready')">é‡æ–°å°è¯•</button>
  </div>
</div>

<!-- å¼•å…¥ jsQR ç”¨äºäºŒç»´ç è§£ç  -->
<script src="jsqr.min.js"></script>
<script>
var stream = null;
var scanTimer = null;
var video = document.getElementById('video');
var canvas = document.getElementById('qr-canvas');
var ctx = canvas.getContext('2d');

function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// â”€â”€ æ‘„åƒå¤´æ‰«ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startScan() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 640 } }
    });
    video.srcObject = stream;
    showView('view-camera');
    scanTimer = requestAnimationFrame(scanFrame);
  } catch(e) {
    showError('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼š' + e.message + '\nè¯·ç¡®è®¤æµè§ˆå™¨å·²æˆæƒæ‘„åƒå¤´æƒé™');
  }
}

function stopScan() {
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  if (scanTimer) { cancelAnimationFrame(scanTimer); scanTimer = null; }
  showView('view-ready');
}

function scanFrame() {
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    var img = ctx.getImageData(0, 0, canvas.width, canvas.height);
    // jsQR è§£ç 
    if (typeof jsQR !== 'undefined') {
      var code = jsQR(img.data, img.width, img.height, { inversionAttempts: 'dontInvert' });
      if (code && code.data) {
        stopScan();
        handleQRCode(code.data);
        return;
      }
    }
  }
  scanTimer = requestAnimationFrame(scanFrame);
}

// â”€â”€ å¤„ç†æ‰«åˆ°çš„äºŒç»´ç å†…å®¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleQRCode(raw) {
  var data;
  try { data = JSON.parse(raw); } catch(e) {
    showError('äºŒç»´ç æ ¼å¼æ— æ•ˆï¼Œè¯·åœ¨ä¸»èŠ‚ç‚¹é‡æ–°ç”Ÿæˆé…å¯¹ç ');
    return;
  }

  if (!data.ip || !data.token) {
    showError('äºŒç»´ç å†…å®¹ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ç”Ÿæˆ');
    return;
  }

  // æ£€æŸ¥æœ‰æ•ˆæœŸ
  if (data.expire && Date.now() / 1000 > data.expire) {
    showError('é…å¯¹ç å·²è¿‡æœŸï¼ˆæœ‰æ•ˆæœŸ10åˆ†é’Ÿï¼‰ï¼Œè¯·åœ¨ä¸»èŠ‚ç‚¹é‡æ–°ç”Ÿæˆ');
    return;
  }

  // å¼€å§‹é…å¯¹æµç¨‹
  showView('view-pairing');
  stepDone('step-qr');
  doPairing(data.ip, data.token);
}

// â”€â”€ æ­¥éª¤çŠ¶æ€æ›´æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stepDone(id)   { setStep(id, 'âœ“', 'done'); }
function stepActive(id, txt) { setStep(id, 'âŸ³', 'active', txt, true); }
function stepError(id, txt)  { setStep(id, 'âœ—', 'error', txt); }

function setStep(id, icon, cls, txt, spin) {
  var el = document.getElementById(id);
  if (!el) return;
  el.className = 'progress-item ' + cls;
  el.querySelector('.step-icon').innerHTML = spin
    ? '<span class="spin">' + icon + '</span>'
    : icon;
  if (txt) el.querySelector('span:last-child').textContent = txt;
}

// â”€â”€ å‘æœ¬æœºåç«¯å‘èµ·é…å¯¹ï¼ˆè°ƒç”¨ /cgi-bin/easymesh-pairï¼‰â”€
async function doPairing(masterIp, token) {
  try {
    // è°ƒç”¨æœ¬æœº CGIï¼Œä¼ å…¥ä¸»èŠ‚ç‚¹ IP å’Œ token
    // CGI è´Ÿè´£è¿æ¥ä¸»èŠ‚ç‚¹ã€æ‹‰å–é…ç½®ã€å†™å…¥UCI
    stepActive('step-connect', 'è¿æ¥ä¸»èŠ‚ç‚¹ ' + masterIp + '...');

    var resp = await fetch('/cgi-bin/easymesh-pair', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ master_ip: masterIp, token: token }),
      signal: AbortSignal.timeout(120000)  // 2åˆ†é’Ÿè¶…æ—¶
    });

    var result = await resp.json();

    if (result.step === 'connected') {
      stepDone('step-connect');
      stepActive('step-config', 'è·å– Mesh é…ç½®...');
    }
    if (result.step === 'config_received') {
      stepDone('step-config');
      stepActive('step-apply', 'å†™å…¥é…ç½®å¹¶é‡å¯...');
    }
    if (result.status === 'ok') {
      stepDone('step-connect');
      stepDone('step-config');
      stepDone('step-apply');
      setTimeout(() => showView('view-success'), 500);
    } else {
      throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
    }

  } catch(e) {
    showError('é…å¯¹å¤±è´¥ï¼š' + e.message);
  }
}

function showError(msg) {
  document.getElementById('error-msg').textContent = msg;
  showView('view-error');
}
</script>
</body>
</html>
