#!/bin/sh
# /www/easymesh-pair/cgi-bin/pair
# 从节点配对 CGI - 端口 8080，无需认证
# 接收主节点 IP + token，拉取配置，写入 UCI，重启服务

printf 'Content-Type: application/json\r\nCache-Control: no-cache\r\n\r\n'

read -r body

json_get() { printf '%s' "$1" | grep -o "\"${2}\":\"[^\"]*\"" | head -1 | cut -d'"' -f4; }

master_ip=$(json_get "$body" "master_ip")
token=$(json_get "$body" "token")

fail() { printf '{"status":"error","error":"%s"}' "$1"; exit 0; }

# 参数校验
[ -z "$master_ip" ] || [ -z "$token" ] && fail "缺少参数"
printf '%s' "$master_ip" | grep -qE '^[0-9]{1,3}(\.[0-9]{1,3}){3}$' || fail "IP 格式无效"

MASTER_PORT=4304

# Step 1: 确认主节点在线
ping_resp=$(wget -q -T 5 -O- "http://${master_ip}:${MASTER_PORT}/easymesh/ping" 2>/dev/null)
printf '%s' "$ping_resp" | grep -q '"easymesh_master"' \
    || fail "无法连接主节点 ${master_ip}:${MASTER_PORT}，请确认主节点已启用 EasyMesh"

# Step 2: 用 token 换取配置（一次性）
cfg=$(wget -q -T 10 -O- \
    "http://${master_ip}:${MASTER_PORT}/easymesh/qr-config?token=${token}" 2>/dev/null)

printf '%s' "$cfg" | grep -q '"status":"expired"' && fail "配对码已过期，请在主节点重新生成"
printf '%s' "$cfg" | grep -q '"status":"invalid"'  && fail "配对码无效，请重新扫描"
printf '%s' "$cfg" | grep -q '"status":"approved"' || fail "主节点拒绝了配对请求"

# Step 3: 解析配置字段
mesh_id=$(json_get "$cfg" "mesh_id")
mesh_key=$(json_get "$cfg" "mesh_key")
ssid=$(json_get "$cfg" "ssid")
wifi_key=$(json_get "$cfg" "wifi_key")
mobility_domain=$(json_get "$cfg" "mobility_domain")
ieee80211r=$(json_get "$cfg" "ieee80211r")
ieee80211k=$(json_get "$cfg" "ieee80211k")
ieee80211v=$(json_get "$cfg" "ieee80211v")
mesh_band=$(json_get "$cfg" "mesh_band")
routing_algo=$(json_get "$cfg" "routing_algo")

[ -z "$mesh_id" ] && fail "配置数据不完整（缺少 mesh_id）"

# Step 4: 写入 UCI
uci batch << UCIEOF
set easymesh.global.enabled=1
set easymesh.global.role=slave
set easymesh.global.mesh_id=$mesh_id
set easymesh.global.mesh_key=$mesh_key
set easymesh.global.ssid=$ssid
set easymesh.global.key=$wifi_key
set easymesh.global.mobility_domain=${mobility_domain:-aabb}
set easymesh.global.ieee80211r=${ieee80211r:-1}
set easymesh.global.ieee80211k=${ieee80211k:-1}
set easymesh.global.ieee80211v=${ieee80211v:-1}
set easymesh.global.mesh_band=${mesh_band:-5g}
set easymesh.global.routing_algo=${routing_algo:-BATMAN_IV}
set easymesh.global.backhaul=wireless
commit easymesh
UCIEOF

# 通知主节点配置已完成
wget -q -T 5 -O/dev/null \
    "http://${master_ip}:${MASTER_PORT}/easymesh/confirm?token=${token}" 2>/dev/null

# 返回成功（先返回，再后台重启）
printf '{"status":"ok"}'

# 后台延迟重启，确保 HTTP 响应已发出
( sleep 2 && /etc/init.d/easymesh restart ) &
