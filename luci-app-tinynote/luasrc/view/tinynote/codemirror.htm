<!-- https://www.min.jsdelivr.com/package/npm/codemirror -->
<%
  local fs  = require "nixio.fs"
  local sys = require "luci.sys"
  local uci = require "luci.model.uci".cursor()
  local con = uci:get_all("luci", "tinynote")
  local id_model = {}
  for sum in sys.exec("seq -w 01 " .. con.note_sum):gmatch("%d+") do
      local id = 'cbid.luci.tinynote.note' .. sum .. '.' .. con.note_type
      id_model[id] = {}
      id_model[id]['path_note' .. sum] = con.note_type
      id_model[id]['only_note' .. sum] = con.only or '0'
      for note, model in pairs(con) do
          if note:find('path_note' .. sum) then
              id_model[id][note] = model
          elseif note:find('only_note' .. sum) then
              id_model[id][note] = model
          end
      end
  end
%>
<style>
  .CodeMirror {
    font-size: <%=con.font_size%>px;
    line-height: <%=con.line_spacing%>%;
    resize: both !important;
    text-align: left !important;
    font-family: Consolas, monospace !important;
    border-top: 1px solid black;
    border-bottom: 1px solid black;
  }
  .CodeMirror-focused .cm-matchhighlight {
    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAFklEQVQI12NgYGBgkKzc8x9CMDAwAAAmhwSbidEoSQAAAABJRU5ErkJggg==);
    background-position: bottom;
    background-repeat: repeat-x;
  }
  dt {font-family: monospace; color: hsl(0, 9%, 46%);}
  .cm-matchhighlight {background-color: hsl(256, 58%, 45%)}
  .CodeMirror-selection-highlight-scrollbar {background-color: rgb(192, 23, 23)}
</style>

<link rel="stylesheet" href="https://cdn.staticfile.org/codemirror/6.65.7/codemirror.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/codemirror/6.65.7/addon/lint/lint.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/codemirror/6.65.7/addon/dialog/dialog.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/codemirror/6.65.7/addon/hint/show-hint.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/codemirror/6.65.7/addon/fold/foldgutter.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/codemirror/6.65.7/addon/display/fullscreen.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/codemirror/6.65.7/addon/search/matchesonscrollbar.min.css">
<!-- theme -->
<link rel="stylesheet" href="https://cdn.staticfile.org/codemirror/6.65.7/theme/<%=con.theme%>.min.css">

<!-- <script src="http://lib.sinaapp.com/js/jquery/2.2.4/jquery-2.2.4.min.js"></script> -->
<script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/codemirror.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/keymap/emacs.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/keymap/sublime.min.js"></script>

<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/dialog/dialog.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/fold/xml-fold.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/fold/foldcode.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/fold/foldgutter.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/fold/brace-fold.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/fold/markdown-fold.min.js"></script>

<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/search/search.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/search/jump-to-line.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/search/searchcursor.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/search/match-highlighter.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/search/matchesonscrollbar.min.js"></script>

<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/selection/active-line.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/selection/mark-selection.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/scroll/annotatescrollbar.min.js"></script>

<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/display/fullscreen.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/display/autorefresh.min.js"></script>

<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/lint/lint.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/lint/yaml-lint.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/hint/xml-hint.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/hint/css-hint.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/hint/html-hint.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/hint/show-hint.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/hint/anyword-hint.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/hint/javascript-hint.min.js"></script>

<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/edit/closetag.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/edit/matchtags.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/addon/edit/closebrackets.min.js"></script>

<!-- mode -->
<script src="https://cdn.staticfile.org/codemirror/6.65.7/mode/xml/xml.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/mode/css/css.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/mode/lua/lua.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/mode/yaml/yaml.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/mode/shell/shell.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/mode/python/python.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/mode/markdown/markdown.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
<script src="https://cdn.staticfile.org/codemirror/6.65.7/mode/yaml-frontmatter/yaml-frontmatter.min.js"></script>

<script>//<![CDATA[
var editor = function(id, editor_mode, editor_only) {
  var editor = CodeMirror.fromTextArea(id, {
    mode: editor_mode,
    autoRefresh: true,          // 自动更新
    lint: true,                 // 检查格式
    tabSize: 4,                 // tab的空格个数
    keyMap: 'sublime',          // sublime编辑器效果
    theme: "<%=con.theme%>",    // 主题
    readOnly: editor_only,      // 只读模式
    foldGutter: true,           // 可将对象折叠，与下面的gutters一起使用
    indentUnit: 4,              // 每个缩进块由几个空格组成。默认为2。
    autocorrect: true,          // 自动更正
    spellcheck: true,           // 拼写检查
    autoCloseBrackets: true,    // 在键入时将自动关闭括号和引号
    smartIndent: true,          // 自动缩进
    lineNumbers: true,          // 是否显示行号
    matchBrackets: true,        // 光标匹配括号
    styleActiveLine: true,      // 选中行高亮
    lineWrapping: true,         // 是否应滚动或换行以显示长行
    lineWiseCopyCut: true,      // 在没有选择的情况下进行复制或剪切将复制或剪切有光标的整行。
    showCursorWhenSelecting: true,  // 选择处于活动状态时是否应绘制光标
    maxHighlightLength: Infinity,   // 默认为 10000（行），最多渲染行数.为 Infinity 时，渲染所有行。
    viewportMargin: 15,         // 渲染可视范围前后的多少行。建议使用默认值 10。
    gutters: ["CodeMirror-lint-markers", "CodeMirror-foldgutter", "CodeMirror-linenumbers", "breakpoints"],
    // highlightSelectionMatches: {showToken: /\w/, annotateScrollbar: true}, //高亮匹配
    extraKeys: {
      "F11": function(cm) {
        cm.setOption("fullScreen", !cm.getOption("fullScreen"));
      },
      "Esc": function(cm) {
        if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
      },
      "Tab": function(cm) {
        if (cm.somethingSelected()) {
          cm.indentSelection('add')
        } else {
          var spaces = Array(cm.getOption("indentUnit") + 1).join(" ")
          cm.replaceSelection(spaces)
        }
      },
      "Alt-F": "findPersistent",
      "Ctrl-J": "toMatchingTag",
    },
  });
  editor.setSize("<%=con.width%>", "<%=con.height%>");
  editor.on("gutterClick", function(cm, n) {
    var info = cm.lineInfo(n);
    cm.setGutterMarker(n, "breakpoints", info.gutterMarkers ? null : makeMarker());
  });

  function makeMarker() {
    var marker = document.createElement("div");
    marker.style.color = "#822";
    marker.innerHTML = "●";
    return marker;
  }
};

function jqid(id) {
  return (!id) ? null : '#' + id.replace(/([#;?%&,.+*~\':"!^$[\]()=>|\/@_])/g, '\\$1');
};

<%
for key, value in pairs(id_model) do
  for k, v in pairs(value) do
    if k:find('path_note') then
      model = v
    elseif k:find('only_note') then
      if v == '1' then only = true else only = false end
    end
    if model == "sh" then model = "shell" end
    if model == "py" then model = "python" end
    if model == "js" then model = "javascript" end
    key = key
  end
  local id = key
  local only = only
  local model = model
%>
  editor(document.getElementById('<%=id%>'), '<%=model%>', '<%=only%>');
<%end%>

//]]>
</script>
