#!/bin/sh /etc/rc.common

START=19

extra_command "reconfig" ""

boot() {
	XBOOT=1 start
}

add_wizard() {
	[ "x$XBOOT" = "x1" ] && return 0
	local cfg="$1"
	config_get wan_proto $cfg wan_proto

	case "$wan_proto" in
		dhcp)
			uci set network.wan.proto="$wan_proto"
		;;
		pppoe)
			config_get wan_pppoe_user $cfg wan_pppoe_user
			config_get wan_pppoe_pass $cfg wan_pppoe_pass
			[[ "$wan_pppoe_user != $(uci -q get network.wan.username 2>/dev/null)" || "$wan_pppoe_pass != $(uci -q get network.wan.password 2>/dev/null)" ]] && {
				uci set network.wan.proto="$wan_proto"
				uci set network.wan.username="$wan_pppoe_user"
				uci set network.wan.password="$wan_pppoe_pass"
			}
		;;
	esac

	config_get lan_ipaddr $cfg lan_ipaddr
	config_get lan_netmask $cfg lan_netmask
	test -n "$lan_ipaddr" && test -n "$lan_netmask" && {
		uci set network.lan.ipaddr="$lan_ipaddr"
		uci set network.lan.netmask="$lan_netmask"
	}

	config_get ipv6 $cfg ipv6
	config_get dhcp $cfg dhcp
	config_get lan_dns $cfg lan_dns
	config_get old_ipv6 $cfg old_ipv6
	config_get siderouter $cfg siderouter
	config_get lan_gateway $cfg lan_gateway
	config_get old_siderouter $cfg old_siderouter

	if [ "$siderouter" != "$old_siderouter" ]; then
		if [[ "$lan_gateway" != "$(uci get network.lan.gateway 2>/dev/null)" ||  "$dhcp" != "$(uci -q get dhcp.lan.ignore 2>/dev/null)" ]]; then
			if [ "$siderouter" == 1 ]; then
				uci -q set network.lan.gateway="$lan_gateway"
				[ "$dhcp" == 1 ] && uci -q set dhcp.lan.ignore="1" || uci -q del dhcp.lan.ignore
				uci -q set firewall.@zone[0].masq='1'
			else
				uci -q del dhcp.lan.ignore
				uci -q del network.lan.dns
				uci -q del network.lan.gateway
				uci -q del firewall.@zone[0].masq
			fi
		fi
		uci -q set wizard.default.old_siderouter="$siderouter"
	fi
	[[ $lan_dns != $(uci -q get network.lan.dns 2>/dev/null) ]] && uci -q set network.lan.dns="$lan_dns"

	if [ "$ipv6" != "$old_ipv6" ]; then
		case "$ipv6" in
		0)
			uci -q set network.wan.ipv6='0'
			uci -q set network.wan.delegate='0'
			;;
		1)
			uci -q delete dhcp.lan.ra
			uci -q delete dhcp.lan.dhcpv6
			uci -q set network.wan.ipv6='0'
			uci -q set network.lan.delegate='0'
			uci -q set network.wan.delegate='0'
			uci -q delete network.globals.ula_prefix
			;;
		2)
			uci -q del network.lan.delegate
			uci -q del network.wan.delegate
			uci -q set dhcp.lan.ra='hybrid'
			uci -q set network.wan.ipv6='auto'
			uci -q set dhcp.lan.dhcpv6='hybrid'
			;;
		esac
		uci -q set wizard.default.old_ipv6="$ipv6"
	fi

	[ -s /etc/config/wireless ] && {
		config_get wifi_key $cfg wifi_key
		config_get wifi_ssid $cfg wifi_ssid
		config_get old_wifi_key $cfg old_wifi_key
		config_get old_wifi_ssid $cfg old_wifi_ssid

		wifi_setup_radio() {
			local radio=$1
			uci -q get wireless.${radio} 2>/dev/null && {
				if [ "$(uci -q get wireless.${radio}.band 2>/dev/null)" = "5g" ]; then
					uci -q set wireless.default_${radio}.ssid="${wifi_ssid}_5G"
				else
					uci -q set wireless.default_${radio}.ssid="${wifi_ssid}_2.4G"
				fi
				uci -q set wireless.default_${radio}.device="$radio"
				if [ "$wifi_key" ]; then
					uci -q set wireless.default_${radio}.key="$wifi_key"
					uci -q set wireless.default_${radio}.encryption='psk2'
				else
					uci -q set wireless.default_${radio}.encryption='none'
				fi
			}
		}

		if [[ "$wifi_ssid" != "$old_wifi_ssid" || "$wifi_key" != "$old_wifi_key" ]]; then
			test -n "$wifi_ssid" && {
				for radio in radio0 radio1 radio2 radio3; do
					wifi_setup_radio "$radio"
				done
				uci commit wireless
			}
			uci -q set wizard.default.old_wifi_key="$wifi_key"
			uci -q set wizard.default.old_wifi_ssid="$wifi_ssid"
		fi
	}

	uci commit dhcp
	uci commit wizard
	uci commit network
	uci commit firewall
	/etc/init.d/network reload &
	/etc/init.d/dnsmasq reload &
}

reconfig() {
	uci -q set wizard.default.lan_dns="$(uci -q get network.lan.dns 2>/dev/null)"
	uci -q set wizard.default.wan_proto="$(uci -q get network.wan.proto 2>/dev/null)"
	uci -q set wizard.default.lan_ipaddr="$(uci -q get network.lan.ipaddr 2>/dev/null)"
	uci -q set wizard.default.lan_netmask="$(uci -q get network.lan.netmask 2>/dev/null)"
	uci -q set wizard.default.lan_gateway="$(uci -q get network.lan.gateway 2>/dev/null)"
	uci -q set wizard.default.wan_pppoe_user="$(uci -q get network.wan.username 2>/dev/null)"
	uci -q set wizard.default.wan_pppoe_pass="$(uci -q get network.wan.password 2>/dev/null)"
	[ "$(uci -q get dhcp.lan.ignore 2>/dev/null)" ] && uci -q set wizard.default.dhcp="0" || uci -q del wizard.default.dhcp 2>/dev/null
	uci commit wizard
}

start() {
	config_load wizard
	config_foreach add_wizard wizard
}

restart() {
	XRELOAD=1 start
}
