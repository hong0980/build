#!/bin/sh
[ -z "$1" ] && exit 0
name="$1"

docker inspect --format '{{.Name}}' "$name" &>/dev/null || exit 0

[ $(($(date +%s) - $(cat "/tmp/last-$name" 2>/dev/null || echo 0))) -lt 15 ] && exit 0
date +%s > "/tmp/last-$name"

uci -q show firewall | grep -q "Docker-$name" && exit 0
uci -q delete "firewall.$name" 2>/dev/null

ip=$(docker inspect -f '{{with index .NetworkSettings.Networks "bridge"}}{{.IPAddress}}{{end}}' "$name" 2>/dev/null)
[ -z "$ip" ] && exit 0

docker port "$name" 2>/dev/null | grep '0.0.0.0:' | while read line; do
	src_dport=$(echo "$line" | cut -d: -f2)
	dest_port=$(echo "$line" | cut -d/ -f1)
	proto=$(echo "$line" | cut -d/ -f2 | cut -d' ' -f1)
	[ -n "$src_dport" ] || continue

	uci -q batch <<-EOF
	set firewall.$name=redirect
	set firewall.$name.name=Docker-$name-$src_dport
	set firewall.$name.src=wan
	set firewall.$name.dest=lan
	set firewall.$name.dest_ip=$ip
	set firewall.$name.proto=$proto
	set firewall.$name.dest_port=$dest_port
	set firewall.$name.src_dport=$src_dport
	EOF
done

[ -n "$(uci -q changes firewall)" ] && {
	uci -q commit firewall
	/etc/init.d/firewall reload >/dev/null 2>&1
}

exit 0
